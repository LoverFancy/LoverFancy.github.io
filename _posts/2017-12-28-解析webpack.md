---
layout:     post
title:      解析webpack
subtitle:   解析webpack
date:       2017-12-28
author:     SkioFox
header-img: img/post-bg-mma-3.jpg
catalog: true
tags:
- webpack
- 前端工具
- 模块化
---

>在前端开发中目前webpack已经是最流行的项目构建和打包工具，其优秀的模块化支持,编译，热更新,代码分割,文件处理,打包等功能深受大家喜爱。使用webpack也有一段时间了,现在整理下自己对webpack的理解。

![avatar](/img/webpack/work.jpg)

上图列举了webpack在前端领域中的应用场景，可以看出已经形成非常全面的工具了, 下面我们将通过示例的方式详解webpack的应用场景。

1. 核心概念
    1. Enrty
        - 打包的入口,代码的入口，多个或者单个
            ```js
                module.exports = {
                    entry: {
                        index: ['index.js','app.js'],
                        vendor: 'vendor.js'
                    }
                }
            ```
    2. Output
        - 打包成的文件(bundle)/一个或者多个/自定义规则
            ```js
                module.exports = {
                    entry: {
                        index: ['index.js','app.js'],
                        vendor: 'vendor.js'
                    },
                    output: {
                        path: `${__dirname}/build/static/`  // __dirname绝对路径
                        filename: '[name].min.[hash:5].js'
                    }
                }
            ```
    3. Loaders
        - 处理除js的其他文件，并将其转化成js模块
            ```js
                module.exports = {
                    module: {
                        rules: [
                            {
                                test: /\.css$/,
                                use: 'css-loader'
                            }
                        ]
                    }
                }
            ```
        - loader的种类
            - 编译相关：babel-loader、ts-loader
            - 样式相关：style-loader、css-loader、less-loader、postcss-loader、stylus-loader
            - 文件相关：file-loader、url-loader
    4. Plugins
        - Plugins的作用
            - 参与打包整个过程
            - 打包优化和压缩
            - 配置编译时的变量
            ```js
                const webpack = require('webpack');
                module.exports = {
                    plugins: [
                        // 混淆和压缩代码
                        new webpack.optimize.UglifyJsPlugin()
                    ]
                }
            ```
        - Plugins的种类
            - 优化相关
                - CommonsChunkPlugin：提取不同chunk之间的相同代码，提取出单独代码块
                - UglifyJsWebpackPlugin：压缩和混淆代码
            - 功能相关
                - ExtractTextWebpackPlugin：提取css为单独的css文件
                - HtmlWebapckPlugin：生成html
                - HotModuleReplacementPlugin: 热更新
                - CopyWebpackPlugin: 拷贝文件，如第三方已打包的文件
    5. webpack中的名词
        - chunk：表示webpack中的代码块
        - Bundle: 代表打包后的文件
        - Module: 模块
2. 使用webpack
    1. webpack命令方式:打包js

        `Usage without config file: webpack <entry> [<entry>] <output>`

    2. webpack配置：
        - 打包js

            `webpack --config webpack.config.js`

        - 编译ES6、ES7、TS

            `npm install babel-loader babel-core babel-preset-env babel-plugin-transform-runtime ts-loader awesome-typescript-loader -D`

            `npm install babel-polyfill babel-runtime -S`

            - Babel
            - Babel-presets：设置编译的浏览器适应版本
            - Babel-plugin
                - Babel Polyfill: 统一浏览器的全局垫片，会在全局引用和处理ES新语法,为引用做准备

                    `import "babel-polyfill"`

                - Babel Runtime Transform: 局部垫片，为框架做准备
                    > 在项目根目录下.babelrc配置babel相关的内容：如target、presets、plugin等
                - typescript-loader
                    > 在根目录配置tsconfig.json
        - 提取公共代码
            ```js
                module.exports = {
                    plugins: [
                        new webpack.optimize.CommonsChunkPlugin({
                            name: 'common',
                            minChunks:2
                        })
                        new webpack.optimize.CommonsChunkPlugin({
                            name: ['vendor','manifest'],
                            minChunks:Infinity
                        })
                        new webpack.optimize.CommonsChunkPlugin({
                            async: 'async-common',
                            children: true,
                            minChunks:Infinity
                        })
                    ]
                }
            ```
        - 代码分割和懒加载
            1. webpack内置方法：require.ensure/require.include
            2. ES2015 Loader spec: System.import -> import() 返回的是Promise

            ```js
            // 动态加载模块
                import(
                    /*webpackChunkName: async-chunk-name*/
                    /*webpackMode: lazy*/
                    modulename     
                )
            ```
            3. 代码分割的场景
                - 分离业务代码和第三方依赖
                - 分离业务代码和业务公共代码和第三方依赖
                - 分离首次加载和访问后加载的代码
                ```js
                    // pageA.js 异步加载lodash
                    // 第一个lodash是引入但并不会执行，第二个lodash才是执行
                    require.ensure(['./lodash'],function () {
                        var _ = require('lodash')
                        _.join([1,2,3])
                    },vendor)
                ```
                ```js
                    // 动态import加载
                    import(/* webpackChunkName: 'lodash' */'./lodash').then(function(){
                        console.log("test")
                    })
                ```
        - 处理css
            ```js
            // 配置css相关loader处理css文件
                module.exports = {
                    module: {
                        rules: [
                            {
                                test: /\.css$/,
                                use: [
                                    /*{
                                        loader: 'style-loader',
                                        options: {
                                            insertInto: '#app',
                                            singleton: true,
                                            transform: './css.transform.js'
                                        }
                                    },
                                    {
                                        loader: 'css-loader',
                                        options: {
                                            // minimize: true,
                                            modules: true,
                                            // 定义样式名称
                                            localIdentName: '[path][name]_[local]_[hash:base64:5]'
                                        }
                                    }*/
                                    /*通过css的link标签插入*/
                                    /*{
                                        loader: 'style-loader/url'
                                    },
                                    {
                                        loader: 'file-loader'
                                    }*/
                                    /*控制样式是否使用use()和unuse()方法*/
                                    {
                                        loader: 'style-loader/useable'
                                    },
                                    {
                                        loader: 'css-loader'
                                    }
                                                                    ]
                            }
                        ]
                    }
                }
            ```
            ```js
                module.exports = {
                    rules:[
                        {
                            test:/\.less$/,
                            // use是从后往前就行处理
                            // extract-text-webpack-plugin用于提取css文件
                            use: ExtractTextWebpackPlugin.extract({
                                // 不提取css的处理方式
                                fallback: {
                                    loader: 'style-loader',
                                    options: {
                                        insertInto: '#app',
                                        singleton: true,
                                        transform: './css.transform.js'
                                    }
                                },
                                // 处理css的loader
                                use:[
                                    {
                                        loader: 'css-loader',
                                        options: {
                                            minimize: true,
                                            modules: true,
                                            localIdentName: '[path][name]_[local]_[hash:base64:5]'
                                        }
                                    },
                                    {
                                        loader:'less-loader'
                                    }
                                ]
                            })
                        },
                        {
                            // 引入模块的loader
                            test: path.resolve(_dirname,'src/app.js'),
                            use: [
                                {
                                    loader: 'imports-loader',
                                    options: {
                                        $: 'jquery'
                                    }
                                }
                            ]
                        }
                    ]
                    plugins: [
                        // extract-text-webpack-plugin用于提取css文件
                        new ExtractTextWebpackPlugin({
                            filename: '[name].mini.css',
                            // 为true时会提取所有的css模块
                            allChunks: false
                        })
                    ]
                }
            ```
        - PostCss in webpack
            - PostCss
                1. 用js去转化css的工具，可以自定义处理css的规则
                    ```js
                        // 安装
                        npm install postcss postcss-loader autoprefixer css-nano css-next
                    ```
                    ```js
                        module.exports = {
                            module: {
                                rules: [
                                    {
                                        test: /\.less$/,
                                        use: [
                                            {
                                                loader: 'style-loader',
                                                options: {
                                                    insertInto: '#app',
                                                    singleton: true,
                                                    transform: './css.transform.js'
                                                }
                                            },
                                            {
                                                loader: 'css-loader',
                                                options: {
                                                    // minimize: true,
                                                    modules: true,
                                                    // 定义样式名称
                                                    localIdentName: '[path][name]_[local]_[hash:base64:5]'
                                                }
                                            },
                                            // postcss用在less/sass和css loader之间
                                            {
                                                loader: 'postcss-loader',
                                                options: {
                                                    // 说明plugin时给postcss使用 
                                                    ident: 'postcss',
                                                    plugins: [
                                                        // 可以在顶部引入和调用
                                                        //  require('autoprefixer')()
                                                        require('postcss-cssnext')()
                                                        // 合成雪碧图
                                                        require('postcss-sprites')({
                                                            // 生成的sprites
                                                            spritePath: 'dist/assets/imgs/sprites',
                                                            // 处理高清的图片
                                                            // 将图片命名为:1@2x.png/2@2x.png/2@2x.png
                                                            retina: true
                                                        })
                                                    ]
                                                }
                                            }
                                            {
                                                loader:'less-loader'
                                            }
                                            
                                        ]
                                    }
                                ]
                            }
                        }
                    ```
            - Autoprefixer
                1. 给css加入浏览器兼容的前缀
            - CSS-nano
                1. 优化和压缩css，同css-loader中minimix属性
            - CSS-next
                1. 可以使用css的新语法会转化成浏览器可识别的语法
            - browserslist
                1. 在package.json中配置公共的浏览器的版本要求，所有都公用一个配置
                ```json
                    "browserslist": [
                        ">= 1%",
                        "last 2 versions"
                    ]      
                ```
                2. .browserslistrc 单独配置文件
        - Tree Shaking(打包时去除未用到的js和css)
            1. 使用场景：引入第三方库或者常规优化时需要使用
            2. JS Tree Shaking和CSS Shaking
                ```js
                module.exports = {
                    plugins: [
                        // 去除css
                        new PurifyCSS({
                            paths: glob.sync([
                                /*
                                path.resolve(_dirname,'./index.html')
                                */
                               // 在src下新建模板文件情况下
                               path.join(_dirname,'./*.html'),
                               path.join(_dirname,'./src/*.js')
                            ])
                        })
                        // 去除未用到的js代码
                        new webpack.optimize.UglifyJsPlugin()
                    ]
                }
                ```
        - 图片文件处理
            1. webpack对图片处理的使用场景及优化
                - CSS引入图片background-image -> file-loader
                - 自动合成雪碧图 -> postcss-sprites
                - 压缩图片 -> img-loader
                - 小图片转base64 编码 -> url-loader
                ```js
                    module.exports = {
                        module: {
                            rules: [
                                {
                                    test: /\.(png|jpg|jpeg|gif)$/,
                                    use: [
                                            /*{
                                                // 处理和加载图片
                                                loader:'file-loader',
                                                options: {
                                                    publicpath:'', 
                                                    outputPath: 'dist/',
                                                    useRelativePath: true
                                                }
                                            },*/
                                            {
                                                // 将图片转化为base64 作为url载入url-loader可以替代file-loader
                                                loader: 'url-loader',
                                                options:{
                                                    // 配置生成的文件名
                                                    name:'[name].min.[ext]',
                                                    // 图片大小限制
                                                    limit:10000,
                                                    publicpath:'', 
                                                    outputPath: 'dist/',
                                                    useRelativePath: true
                                                }
                                            },
                                            {
                                                // 压缩图片
                                                loader:'img-loader',
                                                options: {
                                                    // 压缩格式配置
                                                    pngquant: {
                                                        quality: 80
                                                    }
                                                }
                                            }
                                        ]
                                }
                            ]
                        }
                    }
                ```
        - 字体文件处理(file-loader/url-loader)
            ```js
                module.exports = {
                    module: {
                        rules: [
                            {
                                test: /\.(eot|woff2?|ttf|svg)$/,
                                use: [
                                        {
                                            // 会打包到css的base64
                                            loader: 'url-loader',
                                            options: {
                                                    name:'[name].min.[ext]',
                                                    limit:5000,
                                                    publicpath:'', 
                                                    outputPath: 'dist/',
                                                    useRelativePath: true
                                            }
                                        }
                                    ]
                            }
                        ]
                    }
                }
            ```
        - 第三方js库处理
            1. 场景：
                - 第三方库在远程的CDN上：通过script标签将cdn地址迁到页面中,然后在源代码中使用即可
                - 在本地源代码的第三方库或者通用库：使用webpack.providePlugin或者imports-loader注入
                    ```js
                        module.exports = {
                            resolve: {
                                alias: {
                                    // 加$代表解析jquery关键词解析到某个文件下，确切匹配
                                    jquery$: path.resolve(_dirname,'src/libs/jquery.min.js')
                                }
                            },
                            plugins: [
                                // 在模块中注入第三方库，不用每次使用都import
                                // 这是通过npm安装
                                /*new webpack.ProvidePlugin({
                                    $: 'jquery'
                                })*/
                                // 本地源代码依赖的库需要配置路径
                                new webpack.ProvidePlugin({
                                    $: 'jquery'
                                })
                            ]
                        }
                    ```
        - HTML中引入图片进行压缩
            ```js
                module.exports = {
                    module: {
                        rules: [
                            {
                                test: /\.html$/,
                                use: [
                                    {
                                        loader: 'html-loader',
                                        options: {
                                            // 对img进行处理
                                            attrs: ['img:src','img:data-src']
                                        }
                                    },
                                ]
                            }
                        ]
                    }
                }
            ```
        - 配合优化
            - 提前载入webpack加载代码，如用script标签将公共代码插入到html中，从而减少请求。
                - inline-manifest-wepack-plugin
                - html-webpack-inline-chunk-plugin(和html-loader配合)
                ```js
                    module.exports = {
                        rules: [
                            {
                                test: /\.js$/,
                                use: [
                                    {
                                        loader: 'babel-loader',
                                        options: {
                                            preset: ['env']
                                        }
                                    }
                                ]
                            }
                        ]
                        plugins: [
                            // 提取公共代码
                            new webpack.optimize.CommonsChunkPlugin({
                                name: 'manifest',
                            })
                            // 将公共代码用script提前插入html
                            new HtmlInlineChunkPlugin({
                                inlineChunks: ['manifest']
                            })
                            new HtmlWebpackPlugin({
                                filename: 'index.html',
                                template: './index.html',
                                minify: {
                                    collapseWhitespace: true
                                }
                            })
                            // 每次打包清除dist的插件
                            new CleanWebpackPlugin(['dist'])
                        ]
                    }

                ```
    3. webpack开发环境搭建
        - 搭建本地服务器开发环境可以模拟真实的web服务器环境, 可以更好的调试代码。
        - webpack watch mode:只能监听, 没有服务器
            ```js
                // 命令
                webpack -w --progress --display-reasons --color
            ```
        - webpack-dev-server:官方提供的服务器
            - live reloading：刷新浏览器
            - 路径重定向
            - 支持https
            - 浏览器显示编译错误
            - 接口代理
            - 模块热更新(不刷新浏览器的情况下更新)
            - devServer字段模式(inline/contentBase/port/historyApiFallback/https/proxy/hot/openpage/lazy/overlay)
            ```js
                module.exports = {
                    // 配置webpack-dev-server
                    // 在 package.json配置："serve": "webpack-dev-server --watch --inline --open“
                    // 完整配置："serve": "webpack-dev-server --watch --inline --open --config webpack--dev-server.js"
                    devServer: {
                        // 不刷新浏览器
                        // inline:false,
                        port: 9001,
                        // 解决h5 history 导致的404
                        // historyApiFallback: true // 所有的路径都被重置到了首页
                        historyApiFallback: {
                            // 跳转规则
                            rewrites: [
                                {
                                    // from: 'pages/a',
                                    // to: 'pages/a.html'
                                    // 配置rewrite规则
                                    httpAcceptHeaders: ['text/html','application/xhtml+xml'],
                                    // 正则匹配
                                    from: /^\/([a-zA-Z0-9]+\/?)([a-zA-Z0-9])/,
                                    to:function (context){
                                        return '/' + context.match[1] + context.match[2] + '.html'
                                    }
                                }
                            ]
                        },
                        // 代理远程接口请求：http-proxy-middleware(options:target/changeOrigin/headers/logLevel/pathRewrite)
                        proxy: {
                            // 匹配路径
                            '/api':{
                                // 实际请求的地址
                                target: 'https://m.weibo.cn',
                                // 改变源到url
                                changeOrigin: true,
                                // 请求携带header，增加header内容，请求需要身份验证的接口
                                headers: {
                                    Cookie: 'xxxx'
                                },
                                // 重定向接口请求，方便书写
                                pathReWrite:{
                                    '^/comments': '/api/comments'
                                },
                                // logLevel: 'debug',
                                // 热更新：webpack.HotModuleReplacementPlugin/webpack.NamedModulesPlugin
                                // 好处：保持应用的数据状态/节省调试时间/样式调试更快
                                hot: true
                            }
                        }
                    }
                }
            ```
        - express + webpack-dev-middleware：灵活配置 
            ```js
                //安装依赖：express/koa opn webpack-middleware webpack-hot-middleware http-proxy-middleware connect-history-api-fallback
                // 配置server.js
                const express = require('express')
                const webpack = require('webpack')
                // 打开浏览器调试
                const opn = require('opn')
                
                const app = express()
                const port = 3000

                const webpackDevMiddleWare = require('webpack-dev-middleware')
                const webpackHotMiddleWare = require('webpack-hot-middleware')
                const proxyMiddleWare = require('http-proxy-middleware')
                const historyApiFallback = require('connect-history-api-fallback')

                // 将开发环境的配置载入
                const config = require('./webpack.base.conf')('development')
                const compiler = webpack(config)

                // 载入proxy和historyApiFallback配置
                const proxyTable = require('./proxy')

                for (let context in proxyTable) {
                    app.use(proxyMiddleware(context, proxyTable[context]))
                }

                app.use(historyApiFallback(require('./historyApiFallback')))

                // 使用中间件   
                app.use(webpackDevMiddleWare(compiler,{
                    publicPath: config.output.publicPath
                }))
                app.use(webpackHotMiddleWare(compiler))


                app.listen( port, function() {

                    console.log('listen to localhost:' + port)
                    // 打开
                    opn('http://localhost:' + port)
                })

               
            ```
        - Source Map 调试：会将生成的打包代码和原始的代码进行映射
            - JS Source Map (Devtool/webpack.SourceMapDevToolPlugin/webpack.EvalSourceMapDevToolPlugin)
            - CSS Source Map
        - Eslint 检查代码格式(eslint/eslint-loader/eslint-plugin-html/eslint-friendly-formatter)
            - 在webpack config新增eslint-loader
            - 在根目录下建立 .eslintrc 文件配置书写规则
            - 在package.json在eslintConfig中书写规则
            - JS Standard Style https://standardjs.com/ (eslint-config-standard/eslint-plugin-promise/eslint-plugin-standard/eslint-plugin-import/eslint-plugin-node/eslint-config-xx)
            ```js
                module.exports = {
                    module: {
                        rules: [
                            test: /\.js$/,
                            include: [path.resolve(_dirname,'src')],
                            exclude: [path.resolve(_dirname,'src/libs')]
                            use: [
                                {
                                    loader: 'babel-loader',
                                    options: {
                                        presets: ['env']
                                    }
                                },
                                {
                                    loader: 'eslint-loader',
                                    options: {
                                        formatter: require('eslint-friendly-formatter')
                                    }
                                }
                            ]
                        ]
                    }
                }
            ```
            ```js
                // .eslintrc.js
                module.exports = {
                    root: true,
                    extends: 'standard',
                    plugins:[

                    ],
                    // 全局变量
                    globals: {
                        $: true
                    }
                    rules: {
                        // 缩进
                        indent: ['error',4],
                        // 换行
                        'eol-last': ['error',never]
                    },
                    env: {
                        browsers: true
                    }
                }
            ```
        - 区分开发环境和生产环境(webpack-merge -> webpack.dev.conf.js/webpack.prod.conf.js/webpack.base.conf. js)
            - 开发环境
                - 模块热更新
                - sourceMap
                - 接口代理
                - 代码规范检查
            - 生产环境
                - 提取公用代码
                - 压缩混淆
                - 文件压缩或者base 64编码
                - 去除无用代码
            - 共同点
                - 同样的入口
                - 同样的代码处理(loader处理)
                - 同样的解析配置 
            ```js
                // webpack.base.conf.js

                const productionConfig = require('./webpack.prod.conf')
                const developmentConfig = require('./webpack.dev.conf')

                const merge = require('webpack-merge')

                const generateConfig = env => {
                    return {
                        // 公共的配置部分
                        // 公共的部分如果需要环境判断则用env去判断，多个loader判断使用concat连接
                    }
                }
                module.exports = env => {
                    let config = env === 'production' ? productionConfig : developmentConfig

                    return merge(generateConfig(env), config)
                }
            ```
> 本文首次发布于 [SkioFox Blog](http://blog.skiofox.top), 作者 [SkioFox](https://github.com/LoverFancy/) ,转载请保留原文链接.